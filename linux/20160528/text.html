<!DOCTYPE HTML>
<html>
    <head>

  	<!-- SEO -->
  	<title>kakao의 L3DSR 구성 사례</title>
  	<meta name="description" content="Overview

서비스 웹서버 Load Balancing을 위한 메커니즘으로 KAKAO에서는 L3DSR 방식을 사용하고 있습니다. 멀티IDC에서 L3DSR 방식을 활용, IDC 위치나 서버의 물리적인 위치에 따른 제한없이 서비스 웹서버 Load Balancing이 가">

  	<!-- Meta for robots -->
  	<meta charset="UTF-8">
  	<meta name="revisit-after" content="1 days">
  	<meta name="robots" content="index, follow">
  	<meta name="author" content="">
  	<meta name="generator" content="Jekyll v3.3.1">
  	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  	<!-- Google+ -->
  	<meta itemprop="name" content="kakao의 L3DSR 구성 사례">
  	<meta itemprop="description" content="Overview

서비스 웹서버 Load Balancing을 위한 메커니즘으로 KAKAO에서는 L3DSR 방식을 사용하고 있습니다. 멀티IDC에서 L3DSR 방식을 활용, IDC 위치나 서버의 물리적인 위치에 따른 제한없이 서비스 웹서버 Load Balancing이 가">

  	<!-- Open Graph(Facebook, Pinterest) -->
  	<meta property="og:type" content="website">
  	<meta property="og:url" content="/linux/20160528/text">
  	<meta property="og:title" content="kakao의 L3DSR 구성 사례">
  	<meta property="og:locale" content="">
  	<meta property="og:site_name" content="">
  	<meta property="og:description" content="Overview

서비스 웹서버 Load Balancing을 위한 메커니즘으로 KAKAO에서는 L3DSR 방식을 사용하고 있습니다. 멀티IDC에서 L3DSR 방식을 활용, IDC 위치나 서버의 물리적인 위치에 따른 제한없이 서비스 웹서버 Load Balancing이 가">

  	<!-- Twitter -->
  	<meta name="twitter:title" content="kakao의 L3DSR 구성 사례">
  	<meta name="twitter:site" content="">
  	<meta name="twitter:url" content="/linux/20160528/text">
  	<meta name="twitter:creator" content="">
  	<meta name="twitter:card" content="summary_large_image">
  	<meta name="twitter:description" content="Overview

서비스 웹서버 Load Balancing을 위한 메커니즘으로 KAKAO에서는 L3DSR 방식을 사용하고 있습니다. 멀티IDC에서 L3DSR 방식을 활용, IDC 위치나 서버의 물리적인 위치에 따른 제한없이 서비스 웹서버 Load Balancing이 가">

  	<!-- If article has a cover photo -->
  	

  	<!-- iOS web app -->
  	<meta name="format-detection" content="telephone=yes">
  	<meta name="apple-mobile-web-app-capable" content="yes">
  	<meta name="apple-mobile-web-app-title" content="kakao의 L3DSR 구성 사례">
  	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  	<!-- Search engine verifications -->
  	<meta name="msvalidate.01" content="">
  	<meta name="yandex-verification" content="">
  	<meta name="google-site-verification" content="">

  	<!-- Favicon & RSS -->
  	<link rel="icon" href="/assets/img/favicon.ico">
  	<link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">

  	<!-- CSS & JS files -->
    <!--[if lte IE 8]><script src="js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/devicon.min.css">

    <!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
    <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
</head>

	<body>
        <!-- Header -->
<header id="header">
    <h1><a href="http://localhost:4000">yooonsj's blog</a></h1>
    <span>Trust Me, I'm a "Programmer"</span>
    <!-- <nav class="links"><ul><li><a href="#">Category</a></li></ul></nav>-->
    <nav class="main">
        <ul>
            <!--<li class="search"><a class="fa-search" href="#search">Search</a><form id="search" method="get" action="#"><input type="text" name="query" placeholder="Search" /></form></li>-->
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>

<!-- Menu -->
<section id="menu">
    <!-- Search -->
    <section>
        <form class="search" method="get" action="#">
            <input type="text" name="query" placeholder="Search" />
        </form>
    </section>

    <!-- Links -->
    <section>
        <ul class="links">
            
                
                

                
                
                <li>
                    <a href="/jekyll">
                        <h3>JEKYLL(3)</h3>
                    </a>
                    <p class="tags">
                        
                            <a href="/tags/jekyll">jekyll</a>
                        
                            <a href="/tags/update">update</a>
                        
                    </p>
                </li>
            
                
                

                
                
                <li>
                    <a href="/update">
                        <h3>UPDATE(3)</h3>
                    </a>
                    <p class="tags">
                        
                            <a href="/tags/jekyll">jekyll</a>
                        
                            <a href="/tags/update">update</a>
                        
                    </p>
                </li>
            
                
                

                
                
                <li>
                    <a href="/linux">
                        <h3>LINUX(1)</h3>
                    </a>
                    <p class="tags">
                        
                            <a href="/tags/devops">devops</a>
                        
                            <a href="/tags/l3dsr">l3dsr</a>
                        
                            <a href="/tags/load-balancing">load-balancing</a>
                        
                            <a href="/tags/network">network</a>
                        
                    </p>
                </li>
            
        </ul>
    </section>
    <!-- Actions -->
    <!-- <section>
    <ul class="actions vertical">
    <li><a href="#" class="button big fit">Log In</a></li>
</ul>
</section> -->
</section>

        <div id="post" class="content">
    <div class="cover">
        <a class="category" href="/linux">< linux</a>
        <h1>kakao의 L3DSR 구성 사례</h1>
        <time class="published" datetime="2016-05-28">May 28, 2016</time>
    </div>
    <div class="wrapper">
        <div>
            <!-- Post -->
            <article class="post">
                
                <h2 id="overview">Overview</h2>

<p>서비스 웹서버 Load Balancing을 위한 메커니즘으로 KAKAO에서는 L3DSR 방식을 사용하고 있습니다. 멀티IDC에서 L3DSR 방식을 활용, IDC 위치나 서버의 물리적인 위치에 따른 제한없이 서비스 웹서버 Load Balancing이 가능하도록 구성하고 있습니다.
<!--more--></p>

<h2 id="l3dsr-소개">L3DSR 소개</h2>

<p>보통 서비스에서는 Inbound traffic 대비 Outbound traffic이 월등히 높은데 Outbound traffic을 SLB에서 모두 수용하게 될 경우 리소스 소모가 커질 수 밖에 없습니다. 그래서 Outbound traffic을 서버가 SLB에 전달하지 않고 직접 클라이언트에게 전달해 SLB의 리소스 소모 방지를 위해 사용하는 구성이 DSR(Direct Server Return) 구성입니다. 그리고 클라이언트의 Request를 서버로 전달함에 있어 어떤 헤더를 이용하는지에 따라 L2/L3 DSR로 구분하게 됩니다. L3DSR 은 Load Balancing 을 위한 메커니즘 중 DSR 방식에서 기존 L2 Layer 의 DSR 방식의 한계를 개선하기 위해 사용하는 기술입니다. L3DSR 구성은 IP 헤더중 어떠한것을 이용하는지에 따라 IP Tunnel 기반과 TOS(DSCP) 기반으로 구분되는데 카카오는 DSCP 기반의 L3DSR 방식을 사용하고 있습니다.</p>

<h3 id="l2dsr-과-l3dsr의-차이">L2DSR 과 L3DSR의 차이</h3>

<p>L2DSR은 L2 Layer 헤더인 MAC 주소 변경을 통해 클라이언트의 Request가 전달되는 반면 L3DSR은 IP헤더를 변조하여 서버에 Request를 전달하는 구성입니다. L2DSR의 경우는 MAC 주소 변경을 위해 서버와 ADC 모두 동일한 Broadcast 도메인에 포함되어야 했고, 그로인한 물리적 회선, 위치등의 한계성이 있었습니다. 그러나 L3DSR의 경우 SLB에서 IP 주소 변경을 통해 클라이언트의 Request가 서버로 전달되기 때문에 L2DSR에서의 물리적인 한계성을 극복 할 수 있습니다. 카카오는 서로 다른곳에 각각 위치한 IDC라도 L3DSR 구성을 통해 Load Balancing이 가능하도록 사용하고 있습니다.</p>

<p>![L3DSR 구성에서의 패킷 흐름]</p>

<p>위 그림을 보면 클라이언트는 Destination IP가 211.115.115.100 인 서버로 Request를 보낸것이므로 동일한 IP로부터 Response를 받아야 합니다.  LB장비에서는 211.115.115.100 에 바인딩된 Real Server호스트들의 IP정보를 갖고 있고 IP헤더의 Destination IP를 변조 후 실제 서버로 전달합니다. L2DSR의 경우는 L2 Layer의 Destination MAC 주소를 변조 후 서버로 전달하는데 이 부분이 L2DSR과 L3DSR의 차이점입니다. 이때 서버에서는 Destination IP가 211.115.115.100 으로 들어온 패킷을 자신의 IP가 아니라고 판단하고 버리게 되므로 서버의 lo:0 인터페이스에 VIP를 설정하여 사용합니다.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">abgc</span> <span class="o">=</span> <span class="s1">'efg'</span><span class="p">;</span>
  <span class="nx">cat</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">sysconfig</span><span class="o">/</span><span class="nx">network</span><span class="o">-</span><span class="nx">scripts</span><span class="o">/</span><span class="nx">ifcfg</span><span class="o">-</span><span class="nx">lo</span><span class="err">:</span><span class="mi">0</span>
  <span class="err">#</span><span class="nx">DSR</span> <span class="nx">Loopback</span>
  <span class="nx">DEVICE</span><span class="o">=</span><span class="nx">lo</span><span class="err">:</span><span class="mi">0</span>
  <span class="nx">IPADDR</span><span class="o">=</span><span class="mf">211.115</span><span class="p">.</span><span class="mf">115.100</span>
  <span class="nx">NETMASK</span><span class="o">=</span><span class="mf">255.255</span><span class="p">.</span><span class="mf">255.255</span>
  <span class="nx">NETWORK</span><span class="o">=</span><span class="mf">211.115</span><span class="p">.</span><span class="mf">115.100</span>
  <span class="nx">BROADCAST</span><span class="o">=</span><span class="mf">211.115</span><span class="p">.</span><span class="mf">115.100</span>
  <span class="nx">ONBOOT</span><span class="o">=</span><span class="nx">yes</span>
  <span class="nx">NAME</span><span class="o">=</span><span class="nx">loopback</span><span class="err">:</span><span class="mi">0</span>
</code></pre>
</div>

<ul>
  <li>Netmask 를 255.255.255.255로 설정하여 Broadcast를 방지.</li>
  <li>그리고 카카오에서는 DSCP 기반의 L3DSR 방식을 사용하고 있는데 이는 LB 장비에 설정된 DSCP 값과 서버의 DSCP 값을 동일하게 맞추어 서버에서 Loopback Interface까지 전달이 되도록 IPTABLE로 설정합니다.</li>
</ul>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>cat /etc/sysconfig/iptables
<span class="k">*</span>mangle
:PREROUTING ACCEPT <span class="o">[</span>0:0]
:INPUT ACCEPT <span class="o">[</span>0:0]
:FORWARD ACCEPT <span class="o">[</span>0:0]
:OUTPUT ACCEPT <span class="o">[</span>0:0]
:POSTROUTING ACCEPT <span class="o">[</span>0:0] -A PREROUTING -m dscp --dscp 10 -j DADDR --set-daddr<span class="o">=</span>211.115.115.100 COMMIT
</code></pre>
</div>

<ul>
  <li>DSCP 값은 LB장비와 동일하게 통일. (위 예제는 “10”)</li>
  <li>서버에서는 위 IPTABLE에 따라 IP 헤더의 TOS필드의 DSCP bit값이 동일할경우 211.115.115.100 으로 오는 요청을 허용.</li>
</ul>

<p>위와 같은 설정으로 211.115.115.100 의 주소로 들어온 패킷도 서버에서는 버리지 않고 Loopback Interface에 할당된 IP로 응답하게 됩니다. 이때 서버에서는 LB장비를 거칠필요 없이 Direct로 클라이언트로 응답을 하게 되는것이  L3DSR 방식입니다.</p>

<h3 id="dsr-구성의-부하-분산-방식">DSR 구성의 부하 분산 방식</h3>

<p>![DSR 구성의 부하 분산 방식]</p>

<ol>
  <li>Round Robin
    <ul>
      <li>모든 서버에 균일한 횟수로 접속.</li>
      <li>서버의 부하 상태 등에 대한 고려 없이 일률적으로 부하를 분산함으로써 효과적인 부하 분산을 기대하기 어려움.</li>
    </ul>
  </li>
  <li>Least connection
    <ul>
      <li>서버들 중 세션수가 가장 적은 서버로 사용자 접속을 유도하는 방식.</li>
      <li>서버의 부하 상태등을 고려하여 분삼함.</li>
      <li>단점 : 서버 1대를 추가로 투입할 경우 현재 세션수가 0인 신규 투입 서버로 Request가 몰리는 현상도 있음.</li>
    </ul>
  </li>
</ol>

<p>카카오에서는 Least connection 의 단점을 회피하고자 Round Robin 방식을 사용중입니다.</p>

<h3 id="healthcheck-real-server-healthcheck">HealthCheck (Real Server HealthCheck)</h3>

<ol>
  <li>L2 헬스 체크: ARP 응답 확인 (디폴트로 ICMP 주기의 10배로 자동 설정)</li>
  <li>L3 헬스 체크: Ping 응답 확인</li>
  <li>L4 헬스 체크: 서버에 TCP/UDP 서비스 포트가 활성화되어 있는지 확인</li>
  <li>L7 헬스 체크: 어플리케이션이 올바르게 동작하는지 확인</li>
</ol>

<p>HTTP 예: L2/L3 헬스 체크 성공 =&gt; L4 헬스 체크 성공 =&gt; 리얼서버 업 =&gt; L7 헬스 체크 성공 =&gt; 리얼서버 업 유지</p>

<h4 id="l4-health-check">L4 Health Check</h4>

<p>Layer 4 계층의 TCP/UDP 서비스 port를 체크하는 방식.</p>

<p>TCP 서비스 경우  LB 장비에서는  바인딩된 서버의 포트로 TCP SYN 을 전송하여 SYN+ACK 응답이 오는지를 확인하며 응답이 없다면 서버의 서비스 상태에 문제가 있다고 인식을 하고 바인딩을 하지 않습니다. 그리고 기본적으로 서버가 SYN+ACK을 응답할 경우 서버의 Socket 낭비를 막기 위해 바로 RST을 통해 세션을 끊습니다. 이방법은 LB장비의 부하가 적고 서버의 Socket 낭비가 없는 이점이 있는 반면 실제 서비스 어플리케이션단은 체크를 할수 없는 문제점이 있습니다.</p>

<p>![L4 헬스 체크]</p>

<h4 id="l7-health-check">L7 Health Check</h4>

<p>Layer7 계층의 어플리케이션 응답을 체크하는 방식.</p>

<p>기본적으로 서버와 TCP 세션을 맺고 Request를 (ex. GET /health_check.html) 통해 응답 코드 확인하는 방식입니다. 주기적으로 서버와 세션을 맺기 때문에 부하가 발생하지만 어플리케이션 상태까지 체크할 수 있기 때문에 L4 Health Check 보다 확실한 헬스체크가 가능합니다.</p>

<p>![L7 헬스 체크]</p>

<p>카카오 웹서버군은 거의 대부분 L7 Health Check 방식을 사용합니다. 그로인해 보다 확실한 서비스 안정성을 유지할 수 있도록 합니다.</p>

<h4 id="lb-장비의-설정-예-l7-healthcheck">LB 장비의 설정 예 (L7 HealthCheck)</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>SLB 설정
server port 80
session-sync
tcp
tcp keepalive 10 1
server port 443
session-sync
tcp
tcp keepalive 10 1
server remote-name Hostname 10.10.10.1
port default disable
port http
port http url "GET /health_check.html"
port ssl
port ssl url "GET /health_check.html"
server virtual store-app1 211.115.115.100
tos-marking 10 hc-l3-dsr ====&gt; means "DSCP=10"
port http
bind http Hostname http Hostname http
bind ssl Hostname ssl Hostname ssl
</code></pre>
</div>

<p>![헬스 체크 tcpdump 예]</p>

<h3 id="conclusion">Conclusion</h3>

<p>L2DSR 구성은 이미 여러곳에서 사용되어 오고 있습니다. L3DSR구성도 이미 많이 소개가 되고 보편화 되어 여러사이트에서 사용중인것으로 알고 있습니다. 그러나 L2DSR의 한계점을 극복하기 위해, L3DSR 구성이 서비스의 확장과 멀티 IDC에서의 운영, 확장, 안정성에서도 더 나은 구성임이 분명하기에 조금이나마 도움이 되었으면 하는 바램으로 글을 작성하게 되었습니다.</p>

                <footer>
                    <ul class="stats">
                        
                        <li><a href="#">devops</a></li>
                        
                        <li><a href="#">l3dsr</a></li>
                        
                        <li><a href="#">load-balancing</a></li>
                        
                        <!-- <li><a href="#" class="icon fa-heart">28</a></li> -->
                        <li><a href="#" class="icon fa-comment">128</a></li>
                    </ul>
                </footer>
            </article>
            <ul class="actions pagination">
                
                <li><a href="/update/20151115/welcome-to-jekyll4" class="button big previous">Previous Post</a></li>
                
                
                <li><a href="#" class="disabled button big next">Next Post</a></li>
                
            </ul>
        </div>
    </div>
</div>

		<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/skel.min.js"></script>
<script src="/assets/js/util.js"></script>
<!--[if lte IE 8]><script src="/assets/js/ie/respond.min.js"></script><![endif]-->
<script src="/assets/js/main.js"></script>

	</body>
</html>
